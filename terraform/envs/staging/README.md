# NoteGen AI - Staging Environment

This directory contains the Terraform configuration for deploying the NoteGen AI APIs to a staging environment.

## Prerequisites

1. **AWS CLI configured** with appropriate credentials
2. **Terraform >= 1.0** installed
3. **Docker** installed (for building and pushing images to the auto-created ECR repository)

## Deployment Steps

### 1. Setup Remote State (One-time setup)

First, create the S3 bucket and DynamoDB table for storing Terraform state:

```bash
# Initialize Terraform
terraform init

# Create only the state management resources
terraform apply -target=aws_s3_bucket.tfstate -target=aws_dynamodb_table.tfstate_lock

# Uncomment the backend configuration in backend.tf
# Then reinitialize to migrate state to S3
terraform init
```

### 2. Configure Variables

Copy the example variables file and customize it:

```bash
cp terraform.tfvars.example terraform.tfvars
```

Edit `terraform.tfvars` with your specific values:
- Leave `app_image` empty to use the auto-created ECR repository, or specify a custom image URI
- Adjust resource sizing if needed
- Neo4j password is automatically generated by Terraform

### 3. Deploy Infrastructure

```bash
# Plan the deployment
terraform plan

# Apply the configuration
terraform apply
```

### 4. Verify Deployment

After deployment, you can access:
- **Application**: Use the `application_url` output
- **Neo4j Browser**: Access via VPC/bastion host using the `neo4j_endpoint`
- **OpenSearch Dashboards**: Access via VPC using the `opensearch_kibana_endpoint`

## Important Notes

### Security
- All services are deployed in private subnets
- Neo4j and OpenSearch are only accessible within the VPC
- The application is accessible via the ALB (HTTP only in staging)
- Passwords are stored in AWS Secrets Manager

### Data Persistence
- **Neo4j**: Data is stored on EFS for persistence across container restarts
- **OpenSearch**: Data is stored on EBS volumes
- **Application**: Stateless, no persistent storage

### Costs
This staging environment is configured for cost optimization:
- Single application instance
- Single Neo4j instance
- Small OpenSearch instance (t3.small.search)
- Minimal storage allocations

## Outputs

After deployment, Terraform will output:
- `application_url`: Main application endpoint
- `ecr_repository_url`: ECR repository URL for pushing Docker images
- `neo4j_bolt_uri`: Neo4j connection string
- `opensearch_endpoint`: OpenSearch API endpoint
- Various resource IDs and ARNs

### Accessing Generated Passwords

Neo4j and OpenSearch passwords are automatically generated and stored in AWS Secrets Manager. To retrieve them:

```bash
# Neo4j password
aws secretsmanager get-secret-value --secret-id notegen-staging-neo4j-password --query 'SecretString' --output text | jq -r '.password'

# OpenSearch password  
aws secretsmanager get-secret-value --secret-id notegen-staging-opensearch-password --query 'SecretString' --output text | jq -r '.password'
```

## Cleanup

To destroy the staging environment:

```bash
terraform destroy
```

**Note**: This will delete all data. Make sure to backup any important data first.

## Troubleshooting

### Common Issues

1. **No Docker Image**: After initial deployment, you'll need to build and push your Docker image to the created ECR repository:
   ```bash
   # Get ECR repository URL from Terraform output
   ECR_REPO=$(terraform output -raw ecr_repository_url)
   
   # Build and push your Docker image
   docker build -t notegen-api .
   docker tag notegen-api:latest $ECR_REPO:latest
   
   # Login to ECR and push
   aws ecr get-login-password --region ca-central-1 | docker login --username AWS --password-stdin $ECR_REPO
   docker push $ECR_REPO:latest
   ```
2. **Resource Limits**: Check AWS service limits if resources fail to create
3. **State Lock**: If state is locked, check the DynamoDB table and remove stale locks if needed
4. **Neo4j Password**: Password is automatically generated and stored in AWS Secrets Manager

### Logs

Check application logs in CloudWatch:
```bash
aws logs describe-log-groups --log-group-name-prefix "/ecs/notegen-staging"
```

## Support

For deployment issues, check:
1. AWS CloudFormation events (if using CF backend)
2. ECS service events
3. CloudWatch logs
4. AWS Systems Manager (for parameter values) 